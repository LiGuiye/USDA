<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
	<title>
		Mormon Cricket Density Estimates
	</title>
	<link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
	<script src="https://js.arcgis.com/4.24/"></script>
	<style>
		html,
		body {
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
		}

		#viewDiv {
			padding: 0;
			margin: 0;
			height: 100%;
			width: 100%;
			float: left;
		}

		#infoDiv {
			padding: 8px;
			font-family: Avenir Next W00;
			font-size: 1em;
		}

		#titleDiv {
			padding: 10px;
			width: 320px;
		}

		#titleText {
			font-size: 14pt;
			font-family: 'Times New Roman', Times, serif;
			padding-bottom: 2px;
		}
	</style>
</head>

<body>
	<div id="titleDiv" class="esri-widget">
		<div id="titleText">
			<b>
				Mormon Cricket Density Estimates
			</b>
		</div>
		<div>
			Select Year and State to view estimated Mormon Cricket densities from USDA surveys.
		</div>
	</div>
	<div id="viewDiv"></div>

	<script>
		require([
			"esri/Map",
			"esri/views/MapView",
			"esri/widgets/BasemapGallery",
			"esri/layers/TileLayer",
			"esri/widgets/LayerList",
			"esri/widgets/Legend",
			"esri/widgets/Expand",
			"esri/widgets/Home"
		], function (
			Map,
			MapView,
			BasemapGallery,
			TileLayer,
			LayerList,
			Legend,
			Expand,
			Home
		) {
			var infoDiv = document.getElementById("infoDiv")

			const map = new Map({
				basemap: "topo-vector"
			});

			// const home_center = [-95.3, 29.8]
			const home_center = [-107, 43.4]
			const home_zoom = 7
			const view = new MapView({
				container: "viewDiv",
				map: map,
				center: home_center, // longitude, latitude
				zoom: home_zoom
			});

			view.ui.add("titleDiv", "top-right");

			// Add the home button to the top left corner of the view
			const homeBtn = new Home({
				view: view
			});
			view.ui.add(homeBtn, "top-left");

			function view_go_home() {
				view.goTo({
					center: home_center,
					zoom: home_zoom
				});
			}

			// add year and state filter dropdowns to add or remove layers
			var yearFilter, stateFilter, bioFilter;
			var year = ["2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020"];
			var initialYear = "2002";
			var states = ["Wyoming", "Nevada", "Idaho"];
			var initialState = "Wyoming";
			var bios = [
				"Precipitation", "Soil_Moisture", "Temperature", "Days 20-35\u00B0C",
				"NDVI", "DEM", "Slope", "Aspect", "TRI"];
			var initialBio = "Precipitation";
			yearFilter = document.createElement("select");
			stateFilter = document.createElement("select");
			bioFilter = document.createElement("select");
			filterClass = "esri-widget esri-select";
			filterStyle = "width: 200px; font-family: Avenir Next W00; font-size: 1em;";
			yearFilter.setAttribute("id", "yearSelect");
			yearFilter.setAttribute("class", filterClass);
			yearFilter.setAttribute("style", filterStyle);
			stateFilter.setAttribute("id", "stateSelect");
			stateFilter.setAttribute("class", filterClass);
			stateFilter.setAttribute("style", filterStyle);
			bioFilter.setAttribute("id", "stateSelect");
			bioFilter.setAttribute("class", filterClass);
			bioFilter.setAttribute("style", filterStyle);
			year.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				option.innerHTML = "Year: " + sql;
				yearFilter.appendChild(option);
			});
			states.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				option.innerHTML = "State: " + sql;
				stateFilter.appendChild(option);
			});
			bios.forEach(function (sql) {
				var option = document.createElement("option");
				option.value = sql;
				if (sql == "Soil_Moisture")
					option.innerHTML = "Env: Soil Moisture";
				else{
					option.innerHTML = "Env: " + sql;
				}
				bioFilter.appendChild(option);
			});
			view.ui.add(yearFilter, "top-right");
			view.ui.add(stateFilter, "top-right");
			view.ui.add(bioFilter, "top-right");
			yearFilter.value = initialYear;
			stateFilter.value = initialState;
			bioFilter.value = initialBio;
			yearFilter.addEventListener("change", function (event) {
				initialYear = event.target.value;
				updateLayers(initialYear, initialState, initialBio);
			});
			stateFilter.addEventListener("change", function (event) {
				initialState = event.target.value;
				updateLayers(initialYear, initialState, initialBio);
			});
			bioFilter.addEventListener("change", function (event) {
				initialBio = event.target.value;
				updateLayers(initialYear, initialState, initialBio);
			});
			const state_short = {
				"Wyoming": "WY",
				"Nevada": "NV",
				"Idaho": "ID"
			}
			let center_dict = {
				"Wyoming": [-107.2903, 43.07597],
				"Nevada": [-116.4194, 38.8026],
				"Idaho": [-114.742, 44.0682]
			}
			function updateLayers(year, state, bio) {
				map.removeAll();

				bio_show_pre_year = ["Precipitation", "NDVI", "Temperature", "Soil_Moisture"];
				bio_show_curr_year = ["Days 20-35\u00B0C"];
				if (bio_show_pre_year.includes(bio)) {
					const pre_year = parseInt(year) - 1;
					const curr_layer_bio_fall = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + bio + "_" + state_short[state] + "_"  + pre_year + "_fall/MapServer",
						title: bio + " in " + state + " " + pre_year + " fall",
						listMode: "hide-children"
					});
					const curr_layer_bio_winter = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + bio + "_" + state_short[state] + "_"  + pre_year + "_winter/MapServer",
						title: bio + " in " + state + " " + pre_year + " winter",
						listMode: "hide-children"
					});
					const curr_layer_bio_spring = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + bio + "_" + state_short[state] + "_"  + year + "_spring/MapServer",
						title: bio + " in " + state + " " + year + " spring",
						listMode: "hide-children"
					});
					const curr_layer_bio_summer = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + bio + "_" + state_short[state] + "_"  + year + "_summer/MapServer",
						title: bio + " in " + state + " " + year + " summer",
						listMode: "hide-children"
					});
					map.add(curr_layer_bio_summer);
					map.add(curr_layer_bio_spring);
					map.add(curr_layer_bio_winter);
					map.add(curr_layer_bio_fall);
				}
				else if (bio_show_curr_year.includes(bio)) {
					if (bio == "Days 20-35\u00B0C") {
						field = "Number_of_days_20_to_35_C"
					}
					const curr_layer_bio = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + field + "_" + state_short[state] + "_"  + year + "/MapServer",
						title: bio + " in " + state + " " + year,
						listMode: "hide-children"
					});
					map.add(curr_layer_bio);
				}
				else {
					const curr_layer_bio = new TileLayer({
						url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + bio + "_" + state_short[state] + "/MapServer",
						title: bio + " in " + state,
						listMode: "hide-children"
					});
					map.add(curr_layer_bio);
				}

				const curr_layer = new TileLayer({
					url: "https://tiles.arcgis.com/tiles/b3fMqPOmotX6SV4k/arcgis/rest/services/" + state_short[state] + "_MC_Density_" + year + "/MapServer",
					title: "Estimated Mormon Cricket Density in " + state + " " + year,//state + " Mormon Crickets Density " + year,
					// legendEnabled: false,
					// listMode: "hide",
					listMode: "hide-children",
				})
				map.add(curr_layer);

				view.goTo({
					center: center_dict[state],
					zoom: 7
				});
			}
			updateLayers(initialYear, initialState, initialBio);

			// ----------------------------------------- Add Basemap Gallery -----------------------------------------
			const basemapGallery = new BasemapGallery({
				view: view,
				container: document.createElement("div")
			});

			// Create an Expand instance and set the content
			// property to the DOM node of the basemap gallery widget
			const bgExpand = new Expand({
				view: view,
				content: basemapGallery
			});

			// Add the expand instance to the ui
			view.ui.add(bgExpand, "top-left");

			// ----------------------------------------- Add LayerList & Legend widget -----------------------------------------
			view.ui.add(new LayerList({
				view: view
			}), "bottom-right");

			view.ui.add(new Legend({
				view: view
			}), "bottom-left");

		});
	</script>
</body>

</html>